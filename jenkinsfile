pipeline {
    agent any

    environment {
        AWS_CREDENTIALS = 'aws-cred'            // Your Jenkins AWS Credentials ID
        S3_BUCKET       = 'serverless-api-artifacts-pramod'  // Same as var.s3_bucket_name
        LAMBDA_ZIP      = 'lambda.zip'
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/your-username/project-4-serverless-api.git'
            }
        }

        stage('Install Node Modules') {
            steps {
                dir('lambda') {
                    sh 'npm install'
                }
            }
        }

        stage('Zip Lambda') {
            steps {
                dir('lambda') {
                    sh 'zip -r ../lambda.zip .'
                }
            }
        }

        stage('Upload Lambda to S3') {
            steps {
                withAWS(credentials: "${AWS_CREDENTIALS}") {
                    sh 'aws s3 cp lambda.zip s3://$S3_BUCKET/'
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Output API URL') {
            steps {
                dir('terraform') {
                    script {
                        def api_url = sh(script: "terraform output -raw api_url", returnStdout: true).trim()
                        echo "API URL: ${api_url}"
                    }
                }
            }
        }

        stage('Test API') {
            steps {
                dir('terraform') {
                    script {
                        def api_url = sh(script: "terraform output -raw api_url", returnStdout: true).trim()
                        sh """
                        curl -X POST -H 'Content-Type: application/json' -d '{"id":"1","info":"Hello World"}' ${api_url}
                        curl -X GET '${api_url}?id=1'
                        curl -X PUT -H 'Content-Type: application/json' -d '{"id":"1","info":"Updated Info"}' ${api_url}
                        curl -X DELETE '${api_url}?id=1'
                        """
                    }
                }
            }
        }
    }
}







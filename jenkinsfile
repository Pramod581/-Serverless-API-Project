pipeline {
    agent any

    environment {
        // AWS credentials stored in Jenkins (Credentials ID)
        AWS_CREDENTIALS = 'aws-cred'                  

        // S3 bucket to store Lambda ZIP (must match Terraform var.s3_bucket_name)
        S3_BUCKET       = 'serverless-api-artifacts-pramod'  

        // Name of the zipped Lambda file
        LAMBDA_ZIP      = 'lambda.zip'
    }

    stages {

        stage('Checkout Code') {
            steps {
                // GitHub repository checkout using PAT
                git branch: 'main',
                    url: 'https://github.com/Pramod581/-Serverless-API-Project.git',
                    credentialsId: 'github-cred'  // Jenkins credential ID for GitHub PAT
            }
        }

        stage('Install Node Modules') {
            steps {
                dir('lambda') {
                    // Install Node.js dependencies for Lambda
                    sh 'npm install'
                }
            }
        }

        stage('Zip Lambda') {
            steps {
                dir('lambda') {
                    // Zip the Lambda folder into lambda.zip
                    sh 'zip -r ../lambda.zip .'
                }
            }
        }

        stage('Upload Lambda to S3') {
            steps {
                // Upload Lambda ZIP to S3 using Jenkins AWS credentials
                withAWS(credentials: "${AWS_CREDENTIALS}") {
                    sh 'aws s3 cp lambda.zip s3://$S3_BUCKET/'
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir('terraform') {
                    // Initialize Terraform
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    // Apply Terraform changes automatically
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Output API URL') {
            steps {
                dir('terraform') {
                    script {
                        // Fetch the API Gateway URL from Terraform outputs
                        def api_url = sh(script: "terraform output -raw api_url", returnStdout: true).trim()
                        echo "API URL: ${api_url}"
                    }
                }
            }
        }

        stage('Test API') {
            steps {
                dir('terraform') {
                    script {
                        // Run basic CRUD tests using curl
                        def api_url = sh(script: "terraform output -raw api_url", returnStdout: true).trim()
                        sh """
                        curl -X POST -H 'Content-Type: application/json' -d '{"id":"1","info":"Hello World"}' ${api_url}
                        curl -X GET '${api_url}?id=1'
                        curl -X PUT -H 'Content-Type: application/json' -d '{"id":"1","info":"Updated Info"}' ${api_url}
                        curl -X DELETE '${api_url}?id=1'
                        """
                    }
                }
            }
        }
    }
}







